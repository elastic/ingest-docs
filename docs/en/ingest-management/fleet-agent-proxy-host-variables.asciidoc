[[fleet-agent-proxy-host-variables]]
= Proxy Server connectivity using default host variables

INTRO TBD



/////
//[discrete]
//[[elastic-agent-proxy-config]]
//== When to configure proxy settings

Configure proxy settings for {agent} when it must connect through a proxy server
to:

* Download artifacts from `artifacts.elastic.co` for subprocesses or binary
upgrades (use <<fleet-agent-binary-download-settings>>)
* Send data to {es}
* Retrieve agent policies from {fleet-server}
* Retrieve agent policies from {es} (only needed for agents running {fleet-server})

//image::images/agent-proxy-server.png[Image showing connections between {agent}, {fleet-server}, and {es}]

If {fleet} is unable to access the {package-registry} because {kib} is
behind a proxy server, you may also need to set the registry proxy URL
in the {kib} configuration.

//image::images/fleet-epr-proxy.png[Image showing connections between {fleet} and the {package-registry}]

/////

[discrete]
[[host-proxy-env-vars]]
== Set default proxy settings in host environment variables

Set environment variables on the host to configure default proxy settings.
The {agent} uses host environment settings by default if no proxy settings are
specified elsewhere. You can override host proxy settings later when you
configure the {agent} and {fleet} settings. The following environment variables
are available on the host:

|===
|Variable |Description

|`HTTP_PROXY`
|URL of the proxy server for HTTP traffic. 

|`HTTPS_PROXY`
|URL of the proxy server for HTTPS traffic.

|`NO_PROXY`
|IP addresses or domain names that should not use the proxy. Supports patterns.
|===

The proxy URL can be a complete URL or `host[:port]`, in which case the `http`
scheme is assumed. An error is returned if the value is a different form.

[discrete]
[[where-to-set-proxy-env-vars]]
=== Where to set proxy environment variables

The location where you set these environment variables is platform-specific and
based on the system manager you're using. Here are some examples to get you
started. For more information about setting environment variables, refer to the
documentation for your operating system.

// lint ignore agent
* For Windows services, set environment variables for the service in
the Windows registry.
+
This PowerShell command sets the
`HKLM\SYSTEM\CurrentControlSet\Services\Elastic Agent\Environment` registry
key, then restarts {agent}:
+
[source,yaml]
----
$environment = [string[]]@(
  "HTTPS_PROXY=https://proxy-hostname:proxy-port",
  "HTTP_PROXY=http://proxy-hostname:proxy-port"
  )

Set-ItemProperty "HKLM:SYSTEM\CurrentControlSet\Services\Elastic Agent" -Name Environment -Value $environment

Restart-Service "Elastic Agent"
----

* For Linux services, the location depends on the distribution you're using.
For example, you can set environment variables in:

** `/etc/systemd/system/elastic-agent.service` for systems that use `systemd` to
manage the service. To edit the file, run:
+
[source,shell]
----
sudo systemctl edit --full elastic-agent.service
----
+
Then add the environment variables under `[Service]`
+
[source,shell]
----
[Service]

Environment="HTTPS_PROXY=https://my.proxy:8443"
Environment="HTTP_PROXY=http://my.proxy:8080"
----

** `/etc/sysconfig/elastic-agent` for Red Hat-like distributions that don't use
`systemd`.

** `/etc/default/elastic-agent` for Debian and Ubuntu distributions that don't
use `systemd`.
+
For example:
+
[source,shell]
----
HTTPS_PROXY=https://my.proxy:8443
HTTP_PROXY=http://my.proxy:8080
----

After adding environment variables, restart the service.

NOTE: If you use a proxy server to download new agent versions from `artifacts.elastic.co` for upgrading, configure <<fleet-agent-binary-download-settings>>. 

[discrete]
[[proxy-settings-in-agent-policy]]
== Set {agent} proxy settings in a standalone agent policy

Proxy settings in the {agent} policy override proxy settings specified by
environment variables. This means you can specify proxy settings for {agent}
that are different from host or system-level environment settings. Currently, we only offer a way to modify these for standalone agents. The ability to set these for {fleet}-managed agents is https://github.com/elastic/elastic-agent/issues/96[under consideration]. 

The following proxy settings are valid in the agent policy:

|===
|Setting | Description

|`proxy_url`
| (string) URL of the proxy server. If set, the configured URL is used as a
proxy for all connection attempts by the component. The value may be either a
complete URL or a `host[:port]`, in which case the `http` scheme is assumed. If
a value is not specified through the configuration, then proxy environment
variables are used. The URL accepts optional `username` and `password` settings
for authenticating with the proxy. For example:
`http://<username>:<password>@<proxy host>/`.

|`proxy_headers`
| (string) Additional headers to send to the proxy during CONNECT requests. You
can use this setting to pass keys/tokens required for authenticating with the
proxy.

|`proxy_disable`
| (boolean) If set to `true`, all proxy settings, including the `HTTP_PROXY` and
`HTTPS_PROXY` environment variables, are ignored.

|===

[discrete]
=== Set the proxy for communicating with {es}

To set the proxy for communicating with {es}, specify proxy settings under
`outputs` in the agent policy. The procedure for doing this depends on
whether you're running {fleet}-managed or standalone agents:

// lint disable proxy_url
* For {fleet}-managed agents, specify proxy settings in the {kib} UI:
+
--
. In {kib}, open the main menu, then click *Management > {fleet} > Settings*.

. Under *Outputs*, search for the default output, then click the *Edit* icon in
the *Action* column.

. Under *Advanced YAML configuration*, specify proxy settings for
connecting to {es}. For example:
+
[role="screenshot"]
image::images/proxy_url_settings.png[Screen capture of proxy_url setting]
+
The proxy settings you specify here are applied to all {agent}s enrolled in
{fleet}.
--
// lint enable proxy_url

* For standalone agents, specify proxy settings the `elastic-agent.yml` file. For
example:
+
[source,yaml]
----
outputs:
  default:
    api_key: API-KEY
    hosts:
    - https://10.0.1.2:9200
    proxy_url: http://10.0.1.7:3128
    type: elasticsearch
----
+
For more information, refer to <<elastic-agent-configuration>>.
